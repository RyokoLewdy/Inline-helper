<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miku's Inline Helper - Profile Design Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --primary-teal: #39C5BB;
            --cyan: #00D1D6;
            --pink: #FF6B9D;
            --light-pink: #FF8DB3;
            --black: #0a0a0a;
            --dark-gray: #1a1a1a;
            --medium-gray: #2a2a2a;
            --light-gray: #3a3a3a;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: var(--black);
            font-family: 'Arial', sans-serif;
            color: white;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-teal), var(--cyan));
            padding: 20px 40px;
            box-shadow: 0 4px 20px rgba(0, 209, 214, 0.5);
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 3px solid var(--pink);
        }
        
        .header-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--pink);
            object-fit: cover;
            background: var(--medium-gray);
        }
        
        .header-content {
            flex: 1;
        }
        
        .header h1 {
            color: white;
            text-shadow: 0 0 20px rgba(255, 107, 157, 0.8);
            margin: 0;
            font-size: 32px;
            -webkit-text-stroke: .5px black;
            text-stroke: .5px black;
        }
        
        .header .subtitle {
            color: var(--pink);
            font-size: 14px;
            margin-top: 5px;
            font-weight: bold;
            -webkit-text-stroke: .5px black;
            text-stroke: .5px black;
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 140px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--dark-gray);
            border-right: 2px solid var(--primary-teal);
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .sidebar-nav {
            list-style: none;
            padding: 0;
        }
        
        .sidebar-nav li {
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .sidebar-nav button {
            width: 100%;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: var(--cyan);
            text-align: left;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-nav button:hover {
            background: var(--medium-gray);
            padding-left: 30px;
            color: var(--pink);
        }
        
        .sidebar-nav button.active {
            background: var(--primary-teal);
            color: white;
            border-left: 4px solid var(--pink);
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .category-section {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .category-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            background: var(--medium-gray);
            border: 2px solid var(--primary-teal);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .collapsible-header {
            padding: 15px 20px;
            background: var(--primary-teal);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .collapsible-header:hover {
            background: var(--cyan);
        }
        
        .collapsible-header h3 {
            margin: 0;
            color: white;
            font-size: 16px;
        }
        
        .collapsible-icon {
            color: var(--pink);
            transition: transform 0.3s;
            font-size: 20px;
        }
        
        .collapsible-section.collapsed .collapsible-icon {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            padding: 20px;
            display: block;
        }
        
        .collapsible-section.collapsed .collapsible-content {
            display: none;
        }
        
        /* Controls */
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-label {
            color: var(--cyan);
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            background: var(--dark-gray);
            border: 2px solid var(--primary-teal);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--pink);
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.3);
        }
        
        input[type="range"] {
            flex: 1;
            cursor: pointer;
            accent-color: var(--primary-teal);
        }
        
        input[type="number"].range-value {
            width: 80px;
            padding: 8px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-teal);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .color-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .color-picker {
            width: 50px;
            height: 50px;
            border: 2px solid var(--pink);
            border-radius: 8px;
            cursor: pointer;
        }
        
        .hex-input {
            flex: 1;
        }
        
        button {
            background: linear-gradient(135deg, var(--primary-teal), var(--cyan));
            color: white;
            border: 2px solid var(--pink);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(57, 197, 187, 0.5);
            border-color: var(--pink);
        }
        
        button.secondary {
            background: linear-gradient(135deg, var(--pink), var(--light-pink));
        }
        
        button.danger {
            background: #DC143C;
        }
        
        /* Canvas Container */
        .canvas-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--medium-gray);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--primary-teal);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }
        
        #canvas {
            border: 2px solid var(--pink);
            border-radius: 10px;
            max-width: 400px;
            height: auto;
            display: block;
        }
        
        .canvas-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .canvas-controls button {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        /* Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .preview-modal.active {
            display: flex;
        }
        
        .preview-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .preview-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--primary-teal);
            border: 2px solid var(--pink);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-close:hover {
            background: var(--pink);
        }
        
        .preview-canvas {
            border: 3px solid var(--pink);
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 107, 157, 0.5);
        }
        
        /* Image Upload Areas */
        .upload-area {
            background: var(--dark-gray);
            border: 2px dashed var(--primary-teal);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .preview-box {
            width: 100%;
            height: 150px;
            border: 2px dashed var(--pink);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--black);
            margin-bottom: 10px;
            position: relative;
        }
        
        .preview-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .box-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: var(--cyan);
            opacity: 0.3;
            pointer-events: none;
        }
        
        input[type="file"] {
            display: none;
        }
        
        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        /* Action Bar */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 300px;
            right: 0;
            background: var(--dark-gray);
            border-top: 2px solid var(--primary-teal);
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            z-index: 99;
        }
        
        /* Preset Pills */
        .preset-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-pill {
            padding: 8px 16px;
            background: var(--dark-gray);
            border: 2px solid var(--pink);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            color: var(--cyan);
        }
        
        .preset-pill:hover {
            background: var(--primary-teal);
            transform: scale(1.05);
            color: white;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--black);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-teal);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--cyan);
        }
        
        .info-text {
            color: var(--pink);
            font-size: 12px;
            font-style: italic;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-image">üé§</div>
        <div class="header-content">
            <h1>üé§ Miku's Inline Helper</h1>
            <p class="subtitle">F-List Inline assistant | 1920x1080 | Dark Mode | Fully Customizable</p>
            <p class="subtitle">Made By Bratty Bitch Miku</p>
            <a href="https://www.f-list.net/c/bratty%20bitch%20miku" target="_blank" style="color: var(--pink); text-decoration: none; font-weight: bold; border: 2px solid var(--pink); padding: 8px 24px; border-radius: 8px; display: inline-block; transition: all 0.3s;">
                                    üé§ F-chat contact
                                </a>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <ul class="sidebar-nav">
                <li><button class="nav-btn active" data-category="general">‚öôÔ∏è General Settings</button></li>
                <li><button class="nav-btn" data-category="text">üìù Text & Banner</button></li>
                <li><button class="nav-btn" data-category="colors">üé® Colors</button></li>
                <li><button class="nav-btn" data-category="background">üåü Background</button></li>
                <li><button class="nav-btn" data-category="images">üì∏ Images & Boxes</button></li>
                <li><button class="nav-btn" data-category="layout">üìê Layout & Presets</button></li>
                <li><button class="nav-btn" data-category="advanced">üîß Advanced</button></li>
            </ul>
        </div>
        
<!-- Content Area -->
        <div class="content-area">
            <!-- General Settings -->
            <div class="category-section active" id="section-general">
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üñºÔ∏è Canvas Settings</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showTempBg" onchange="redraw()">
                                <label class="control-label">Show Dark mode Preview</label>
                            </div>
                            <p class="info-text">Background won't appear in downloaded image</p>
                        </div>
                        
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showBoxMarkers" checked onchange="redraw()">
                                <label class="control-label">Show Box Number Markers</label>
                            </div>
                            <p class="info-text">Markers disappear when images are uploaded</p>
                        </div>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üíæ Save / Load Configuration</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <button onclick="saveConfiguration()" style="width: 100%;">üíæ Save Configuration (Does not save images and idk why)</button>
                            <p class="info-text">Downloads a .json file with all your settings</p>
                        </div>
                        
                        <div class="control-group">
                            <button onclick="document.getElementById('loadConfig').click()" class="secondary" style="width: 100%;">üìÇ Load Configuration (does not Load Images and I still dunno why)</button>
                            <input type="file" id="loadConfig" accept=".json" onchange="loadConfiguration(event)">
                            <p class="info-text">Upload a previously saved .json file</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Text & Banner -->
            <div class="category-section" id="section-text">
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üìù Text Content</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <label class="control-label">Main Text</label>
                            <input type="text" id="mainText" value="Miku" oninput="redraw()">
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Subtitle Text</label>
                            <input type="text" id="subtitleText" value="Hatsune" oninput="redraw()">
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Main Font</label>
                            <select id="mainFont" onchange="redraw()">
                                <option value="Comic Sans MS">Comic Sans MS (Default)</option>
                                <option value="Impact">Impact</option>
                                <option value="Arial Black">Arial Black</option>
                                <option value="Brush Script MT">Brush Script MT</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Trebuchet MS">Trebuchet MS</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Palatino">Palatino</option>
                                <option value="Garamond">Garamond</option>
                                <option value="Bookman">Bookman</option>
                                <option value="Comic Sans MS">Comic Sans MS</option>
                                <option value="Candara">Candara</option>
                                <option value="Arial Narrow">Arial Narrow</option>
                                <option value="Century Gothic">Century Gothic</option>
                                <option value="custom">Custom Uploaded Font</option>
                            </select>
                        </div>
                        
                        <div class="control-group" id="customFontUpload" style="display: none;">
                            <label class="control-label">Upload Custom Font (.ttf, .otf, .woff)</label>
                            <button class="secondary" onclick="document.getElementById('fontFile').click()">üì§ Upload Font File</button>
                            <input type="file" id="fontFile" accept=".ttf,.otf,.woff,.woff2" onchange="handleFontUpload(event)">
                            <p class="info-text" id="fontFileName">No font uploaded</p>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Subtitle Font</label>
                            <select id="subtitleFont" onchange="redraw()">
                                <option value="Trebuchet MS">Trebuchet MS (Default)</option>
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Impact">Impact</option>
                                <option value="Georgia">Georgia</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Main Text Size</label>
                            <div class="control-row">
                                <input type="range" id="mainTextSize" min="40" max="150" value="85" oninput="syncSlider('mainTextSize', this.value)">
                                <input type="number" class="range-value" id="mainTextSizeValue" min="40" max="150" value="85" oninput="syncNumber('mainTextSize', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Subtitle Size</label>
                            <div class="control-row">
                                <input type="range" id="subtitleTextSize" min="20" max="80" value="38" oninput="syncSlider('subtitleTextSize', this.value)">
                                <input type="number" class="range-value" id="subtitleTextSizeValue" min="20" max="80" value="38" oninput="syncNumber('subtitleTextSize', this.value)">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üè∑Ô∏è Banner Settings</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <label class="control-label">Banner Shape</label>
                            <select id="bannerShape" onchange="redraw()">
                                <option value="rounded">Rounded Rectangle (Default)</option>
                                <option value="rectangle">Sharp Rectangle</option>
                                <option value="hexagon">Hexagon</option>
                                <option value="ellipse">Ellipse</option>
                                <option value="diamond">Diamond</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Banner X Position</label>
                            <div class="control-row">
                                <input type="range" id="bannerX" min="500" max="1600" value="1050" oninput="syncSlider('bannerX', this.value)">
                                <input type="number" class="range-value" id="bannerXValue" min="500" max="1600" value="1050" oninput="syncNumber('bannerX', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Banner Y Position</label>
                            <div class="control-row">
                                <input type="range" id="bannerY" min="400" max="1000" value="800" oninput="syncSlider('bannerY', this.value)">
                                <input type="number" class="range-value" id="bannerYValue" min="400" max="1000" value="800" oninput="syncNumber('bannerY', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Banner Width</label>
                            <div class="control-row">
                                <input type="range" id="bannerWidth" min="400" max="1200" value="780" oninput="syncSlider('bannerWidth', this.value)">
                                <input type="number" class="range-value" id="bannerWidthValue" min="400" max="1200" value="780" oninput="syncNumber('bannerWidth', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Banner Height</label>
                            <div class="control-row">
                                <input type="range" id="bannerHeight" min="80" max="250" value="140" oninput="syncSlider('bannerHeight', this.value)">
                                <input type="number" class="range-value" id="bannerHeightValue" min="80" max="250" value="140" oninput="syncNumber('bannerHeight', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Banner Rotation (degrees)</label>
                            <div class="control-row">
                                <input type="range" id="bannerRotation" min="-45" max="45" value="-3" oninput="syncSlider('bannerRotation', this.value)">
                                <input type="number" class="range-value" id="bannerRotationValue" min="-45" max="45" value="-3" oninput="syncNumber('bannerRotation', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showSparkles" checked onchange="redraw()">
                                <label class="control-label">Show Sparkles</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Colors -->
            <div class="category-section" id="section-colors">
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üé® Main Colors</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <label class="control-label">Primary Color (Teal)</label>
                            <div class="color-input-group">
                                <input type="color" id="primaryColorPicker" value="#39C5BB" class="color-picker" oninput="syncColor('primaryColor', this.value)">
                                <input type="text" id="primaryColorHex" value="#39C5BB" class="hex-input" oninput="syncColorFromHex('primaryColor', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Accent Color (Pink)</label>
                            <div class="color-input-group">
                                <input type="color" id="accentColorPicker" value="#FF6B9D" class="color-picker" oninput="syncColor('accentColor', this.value)">
                                <input type="text" id="accentColorHex" value="#FF6B9D" class="hex-input" oninput="syncColorFromHex('accentColor', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Banner Color</label>
                            <div class="color-input-group">
                                <input type="color" id="bannerColorPicker" value="#39C5BB" class="color-picker" oninput="syncColor('bannerColor', this.value)">
                                <input type="text" id="bannerColorHex" value="#39C5BB" class="hex-input" oninput="syncColorFromHex('bannerColor', this.value)">
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Banner Color 2 (Gradient)</label>
                            <div class="color-input-group">
                                <input type="color" id="bannerColor2Picker" value="#00D1D6" class="color-picker" oninput="syncColor('bannerColor2', this.value)">
                                <input type="text" id="bannerColor2Hex" value="#00D1D6" class="hex-input" oninput="syncColorFromHex('bannerColor2', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="useBannerGradient" checked onchange="redraw()">
                                <label class="control-label">Use Gradient (disable for solid color)</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Background -->
            <div class="category-section" id="section-background">
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üåü Background Elements</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <label class="control-label">Background Shape Type</label>
                            <select id="bgShapeType" onchange="redraw()">
                                <option value="circles">Gradient Circles (Default)</option>
                                <option value="hexagons">Hexagons</option>
                                <option value="stars">Stars</option>
                                <option value="diamonds">Diamonds</option>
                                <option value="none">None - Disable Shapes</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showDigitalCode" checked onchange="redraw()">
                                <label class="control-label">Show Digital Code</label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Digital Code Text</label>
                            <input type="text" id="digitalCodeText" value="01" maxlength="10" oninput="redraw()">
                        </div>
                        
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showMusicNotes" checked onchange="redraw()">
                                <label class="control-label">Show Decorative Symbols</label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Symbol Type</label>
                            <select id="musicNoteSymbol" onchange="redraw()">
                                <option value="‚ô™">‚ô™ (Music Note)</option>
                                <option value="‚ô´">‚ô´ (Double Note)</option>
                                <option value="‚ô¨">‚ô¨ (Beamed Notes)</option>
                                <option value="‚òÖ">‚òÖ (Star)</option>
                                <option value="‚ô•">‚ô• (Heart)</option>
                                <option value="‚ú¶">‚ú¶ (Sparkle)</option>
                                <option value="‚óÜ">‚óÜ (Diamond)</option>
                            </select>
                        </div>
                        
                    <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showBackgroundLines" checked onchange="redraw()">
                                <label class="control-label">Show Background Lines</label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Custom Background Image</label>
                            <div class="preview-box" id="preview-background" style="height: 100px;">
                                <span class="box-marker">BG</span>
                            </div>
                            <button class="secondary" onclick="document.getElementById('backgroundUpload').click()">üì§ Upload Background</button>
                            <input type="file" id="backgroundUpload" accept="image/*" onchange="handleBackgroundUpload(event)">
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Background Opacity (%)</label>
                            <div class="control-row">
                                <input type="range" id="bgOpacity" min="0" max="100" value="100" oninput="syncSlider('bgOpacity', this.value)">
                                <input type="number" class="range-value" id="bgOpacityValue" min="0" max="100" value="100" oninput="syncNumber('bgOpacity', this.value)">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Background Blur (px)</label>
                            <div class="control-row">
                                <input type="range" id="bgBlur" min="0" max="20" value="0" oninput="syncSlider('bgBlur', this.value)">
                                <input type="number" class="range-value" id="bgBlurValue" min="0" max="20" value="0" oninput="syncNumber('bgBlur', this.value)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Images & Boxes -->
            <div class="category-section" id="section-images">
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üéµ Main Cutout Image</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="upload-area">
                            <div class="preview-box" id="preview-cutout">
                                <span class="box-marker" id="marker-cutout">C</span>
                            </div>
                            <button class="secondary" onclick="document.getElementById('cutout').click()">üì§ Upload Image</button>
                            <input type="file" id="cutout" accept="image/*" onchange="handleImageUpload(event, 'cutout', 0)">
                        </div>
                        
                        <div class="grid-2">
                            <div class="control-group">
                                <label class="control-label">Opacity (%)</label>
                                <div class="control-row">
                                    <input type="range" id="opacity-cutout" min="0" max="100" value="100" oninput="syncSlider('opacity-cutout', this.value)">
                                    <input type="number" class="range-value" id="opacity-cutoutValue" min="0" max="100" value="100" oninput="syncNumber('opacity-cutout', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Zoom (%)</label>
                                <div class="control-row">
                                    <input type="range" id="zoom-cutout" min="50" max="200" value="100" oninput="syncSlider('zoom-cutout', this.value)">
                                    <input type="number" class="range-value" id="zoom-cutoutValue" min="50" max="200" value="100" oninput="syncNumber('zoom-cutout', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Offset X</label>
                                <div class="control-row">
                                    <input type="range" id="offsetX-cutout" min="-200" max="200" value="0" oninput="syncSlider('offsetX-cutout', this.value)">
                                    <input type="number" class="range-value" id="offsetX-cutoutValue" min="-200" max="200" value="0" oninput="syncNumber('offsetX-cutout', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Offset Y</label>
                                <div class="control-row">
                                    <input type="range" id="offsetY-cutout" min="-200" max="200" value="0" oninput="syncSlider('offsetY-cutout', this.value)">
                                    <input type="number" class="range-value" id="offsetY-cutoutValue" min="-200" max="200" value="0" oninput="syncNumber('offsetY-cutout', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="dynamicBoxesContainer">
                    <!-- Dynamic boxes will be generated here -->
                </div>
                
                <div class="control-group">
                    <button onclick="addNewBox()" class="secondary" style="width: 100%;">‚ûï Add New Image Box</button>
                </div>
            </div>
            
            <!-- Layout & Presets -->
            <div class="category-section" id="section-layout">
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üìê Layout Presets</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="preset-pills">
                            <div class="preset-pill" onclick="applyPreset('miku')">üé§ Miku Style</div>
                            <div class="preset-pill" onclick="applyPreset('minimal')">üì± Minimal</div>
                            <div class="preset-pill" onclick="applyPreset('grid')">üìä Grid Layout</div>
                            <div class="preset-pill" onclick="applyPreset('diagonal')">üìê Diagonal</div>
                            <div class="preset-pill" onclick="applyPreset('centered')">üéØ Centered</div>
                        </div>
                        <p class="info-text">Click a preset to instantly apply a layout style</p>
                    </div>
                </div>
            </div>
            
            <!-- Advanced -->
            <div class="category-section" id="section-advanced">
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h3>üîß Advanced Options</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <button onclick="resetToDefaults()" class="danger" style="width: 100%;">üîÑ Reset All to Defaults</button>
                            <p class="info-text">This will reset all settings but keep your uploaded images</p>
                        </div>
                        
                        <div class="control-group">
                            <button onclick="clearAllImages()" class="danger" style="width: 100%;">üóëÔ∏è Clear All Images</button>
                            <p class="info-text">Removes all uploaded images</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mini Canvas Preview -->
    <div class="canvas-container">
        <canvas id="canvas" width="400" height="225"></canvas>
        <div class="canvas-controls">
            <button onclick="openPreview()">üëÅÔ∏è Preview</button>
            <button onclick="downloadImage()">üíæ Download</button>
        </div>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
        <button onclick="openPreview()">üëÅÔ∏è Full Preview</button>
        <button onclick="redraw()">üé® Refresh Canvas</button>
        <button onclick="downloadImage()">üíæ Download PNG (1920x1080)</button>
    </div>
    
    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <button class="preview-close" onclick="closePreview()">‚úï</button>
            <canvas class="preview-canvas" id="previewCanvas" width="1920" height="1080"></canvas>
        </div>
    </div>
    
    <script>
        // Global variables
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');
        
        const SAFE_ZONE = {
            x: 90,
            y: 60,
            width: 1920,
            height: 1080
        };
        
        let primaryColor = '#39C5BB';
        let accentColor = '#FF6B9D';
        let bannerColor = '#39C5BB';
        let bannerColor2 = '#00D1D6';
        let useBannerGradient = true;
        
        let mikuCutout = null;
        let cutoutOpacity = 100;
        let cutoutZoom = 100;
        let cutoutOffsetX = 0;
        let cutoutOffsetY = 0;
        let customBackground = null;
        let bgOpacity = 100;
        let bgBlur = 0;
        
        let boxes = [
            { id: 1, type: 'large', x: 920, y: 450, size: 330, rotation: 45, image: null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
            { id: 2, type: 'large', x: 1250, y: 600, size: 300, rotation: 15, image: null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
            { id: 3, type: 'large', x: 1530, y: 400, size: 280, rotation: -20, image: null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 }
        ];
        
        let nextBoxId = 4;
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeSidebar();
            initializeCollapsibles();
            generateBoxControls();
            redraw();
        });
        
        // Sidebar navigation - FIXED
        function initializeSidebar() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.category-section');
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const category = btn.dataset.category;
                    
                    // Remove active class from all buttons
                    navButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Hide all sections
                    sections.forEach(s => s.classList.remove('active'));
                    
                    // Show selected section
                    const targetSection = document.getElementById(`section-${category}`);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                });
            });
        }
        
        // Collapsible sections - FIXED
        function initializeCollapsibles() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.parentElement.classList.toggle('collapsed');
                });
            });
        }
        
        // Sync slider and number input
        function syncSlider(id, value) {
            const slider = document.getElementById(id);
            const numberInput = document.getElementById(id + 'Value');
            
            if (slider) slider.value = value;
            if (numberInput) numberInput.value = value;
            
            // Update specific values
            if (id.includes('opacity')) {
                const parts = id.split('-');
                if (parts[1] === 'cutout') {
                    cutoutOpacity = parseInt(value);
                } else {
                    const boxId = parseInt(parts[1]);
                    const box = boxes.find(b => b.id === boxId);
                    if (box) box.opacity = parseInt(value);
                }
            } else if (id.includes('zoom')) {
                const parts = id.split('-');
                if (parts[1] === 'cutout') {
                    cutoutZoom = parseInt(value);
                } else {
                    const boxId = parseInt(parts[1]);
                    const box = boxes.find(b => b.id === boxId);
                    if (box) box.zoom = parseInt(value);
                }
            } else if (id.includes('offsetX')) {
                const parts = id.split('-');
                if (parts[1] === 'cutout') {
                    cutoutOffsetX = parseInt(value);
                } else {
                    const boxId = parseInt(parts[1]);
                    const box = boxes.find(b => b.id === boxId);
                    if (box) box.offsetX = parseInt(value);
                }
            } else if (id.includes('offsetY')) {
                const parts = id.split('-');
                if (parts[1] === 'cutout') {
                    cutoutOffsetY = parseInt(value);
                } else {
                    const boxId = parseInt(parts[1]);
                    const box = boxes.find(b => b.id === boxId);
                    if (box) box.offsetY = parseInt(value);
                }
            } else if (id.includes('size-')) {
                const boxId = parseInt(id.split('-')[1]);
                const box = boxes.find(b => b.id === boxId);
                if (box) box.size = parseInt(value);
            } else if (id.includes('rotation-')) {
                const boxId = parseInt(id.split('-')[1]);
                const box = boxes.find(b => b.id === boxId);
                if (box) box.rotation = parseInt(value);
            } else if (id.includes('posX-')) {
                const boxId = parseInt(id.split('-')[1]);
                const box = boxes.find(b => b.id === boxId);
                if (box) box.x = parseInt(value);
            } else if (id.includes('posY-')) {
                const boxId = parseInt(id.split('-')[1]);
                const box = boxes.find(b => b.id === boxId);
                if (box) box.y = parseInt(value);
            }
            
            redraw();
        }
        
        function syncNumber(id, value) {
            syncSlider(id, value);
        }
        
        // Color sync
        function syncColor(type, value) {
            if (type === 'primaryColor') {
                primaryColor = value;
                document.getElementById('primaryColorHex').value = value;
                document.getElementById('primaryColorPicker').value = value;
            } else if (type === 'accentColor') {
                accentColor = value;
                document.getElementById('accentColorHex').value = value;
                document.getElementById('accentColorPicker').value = value;
            } else if (type === 'bannerColor') {
                bannerColor = value;
                document.getElementById('bannerColorHex').value = value;
                document.getElementById('bannerColorPicker').value = value;
            } else if (type === 'bannerColor2') {
                bannerColor2 = value;
                document.getElementById('bannerColor2Hex').value = value;
                document.getElementById('bannerColor2Picker').value = value;
            }
            redraw();
        }
        
        function syncColorFromHex(type, value) {
            if (!/^#[0-9A-F]{6}$/i.test(value)) return;
            syncColor(type, value);
        }
        
        // Generate box controls dynamically
        function generateBoxControls() {
            const container = document.getElementById('dynamicBoxesContainer');
            container.innerHTML = '';
            
            boxes.forEach((box, index) => {
                const section = document.createElement('div');
                section.className = 'collapsible-section';
                section.innerHTML = `
                    <div class="collapsible-header">
                        <h3>üì∏ Image Box ${box.id}</h3>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="upload-area">
                            <div class="preview-box" id="preview-${box.id}">
                                <span class="box-marker" id="marker-${box.id}">${box.id}</span>
                            </div>
                            <button class="secondary" onclick="document.getElementById('upload-${box.id}').click()">üì§ Upload Image</button>
                            <input type="file" id="upload-${box.id}" accept="image/*" onchange="handleBoxImageUpload(event, ${box.id})">
                        </div>
                        
                        <div class="grid-2">
                            <div class="control-group">
                                <label class="control-label">Position X</label>
                                <div class="control-row">
                                    <input type="range" id="posX-${box.id}" min="100" max="1820" value="${box.x}" oninput="syncSlider('posX-${box.id}', this.value)">
                                    <input type="number" class="range-value" id="posX-${box.id}Value" min="100" max="1820" value="${box.x}" oninput="syncNumber('posX-${box.id}', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Position Y</label>
                                <div class="control-row">
                                    <input type="range" id="posY-${box.id}" min="100" max="980" value="${box.y}" oninput="syncSlider('posY-${box.id}', this.value)">
                                    <input type="number" class="range-value" id="posY-${box.id}Value" min="100" max="980" value="${box.y}" oninput="syncNumber('posY-${box.id}', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Size</label>
                                <div class="control-row">
                                    <input type="range" id="size-${box.id}" min="100" max="500" value="${box.size}" oninput="syncSlider('size-${box.id}', this.value)">
                                    <input type="number" class="range-value" id="size-${box.id}Value" min="100" max="500" value="${box.size}" oninput="syncNumber('size-${box.id}', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Rotation (degrees)</label>
                                <div class="control-row">
                                    <input type="range" id="rotation-${box.id}" min="-180" max="180" value="${box.rotation}" oninput="syncSlider('rotation-${box.id}', this.value)">
                                    <input type="number" class="range-value" id="rotation-${box.id}Value" min="-180" max="180" value="${box.rotation}" oninput="syncNumber('rotation-${box.id}', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Opacity (%)</label>
                                <div class="control-row">
                                    <input type="range" id="opacity-${box.id}" min="0" max="100" value="${box.opacity}" oninput="syncSlider('opacity-${box.id}', this.value)">
                                    <input type="number" class="range-value" id="opacity-${box.id}Value" min="0" max="100" value="${box.opacity}" oninput="syncNumber('opacity-${box.id}', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Zoom (%)</label>
                                <div class="control-row">
                                    <input type="range" id="zoom-${box.id}" min="50" max="200" value="${box.zoom}" oninput="syncSlider('zoom-${box.id}', this.value)">
                                    <input type="number" class="range-value" id="zoom-${box.id}Value" min="50" max="200" value="${box.zoom}" oninput="syncNumber('zoom-${box.id}', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Offset X</label>
                                <div class="control-row">
                                    <input type="range" id="offsetX-${box.id}" min="-200" max="200" value="${box.offsetX}" oninput="syncSlider('offsetX-${box.id}', this.value)">
                                    <input type="number" class="range-value" id="offsetX-${box.id}Value" min="-200" max="200" value="${box.offsetX}" oninput="syncNumber('offsetX-${box.id}', this.value)">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label class="control-label">Offset Y</label>
                                <div class="control-row">
                                    <input type="range" id="offsetY-${box.id}" min="-200" max="200" value="${box.offsetY}" oninput="syncSlider('offsetY-${box.id}', this.value)">
                                    <input type="number" class="range-value" id="offsetY-${box.id}Value" min="-200" max="200" value="${box.offsetY}" oninput="syncNumber('offsetY-${box.id}', this.value)">
                                </div>
                            </div>
                        </div>
                        
                        <button class="danger" onclick="deleteBox(${box.id})" style="width: 100%; margin-top: 15px;">üóëÔ∏è Delete This Box</button>
                    </div>
                `;
                container.appendChild(section);
                
                // Re-initialize collapsible for this section
                const header = section.querySelector('.collapsible-header');
                header.addEventListener('click', () => {
                    section.classList.toggle('collapsed');
                });
            });
        }
        
        // Add new box
        function addNewBox() {
            const newBox = {
                id: nextBoxId++,
                type: 'custom',
                x: 1000,
                y: 500,
                size: 250,
                rotation: 0,
                image: null,
                opacity: 100,
                zoom: 100,
                offsetX: 0,
                offsetY: 0
            };
            boxes.push(newBox);
            generateBoxControls();
            redraw();
        }
        
        // Delete box
        function deleteBox(id) {
            if (!confirm('Delete this image box?')) return;
            boxes = boxes.filter(b => b.id !== id);
            generateBoxControls();
            redraw();
        }
        
        // Image uploads
        function handleImageUpload(event, type, index) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    mikuCutout = img;
                    const previewBox = document.getElementById('preview-cutout');
                    previewBox.innerHTML = `<img src="${e.target.result}">`;
                    redraw();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function handleBoxImageUpload(event, boxId) {
            const file = event.target.files[0];
            if (!file) return;
            
            const box = boxes.find(b => b.id === boxId);
            if (!box) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    box.image = img;
                    const previewBox = document.getElementById(`preview-${boxId}`);
                    previewBox.innerHTML = `<img src="${e.target.result}">`;
                    redraw();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Drawing functions
        function drawToContext(targetCtx, targetCanvas, scale = 1) {
            targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
            
            // Temp background 
            const showTempBg = document.getElementById('showTempBg');
            if (showTempBg && showTempBg.checked) {
                targetCtx.fillStyle = '#2e2828';
                targetCtx.fillRect(0, 0, targetCanvas.width, targetCanvas.height);
            }
            
            // Scale context for mini preview
            if (scale !== 1) {
                targetCtx.save();
                targetCtx.scale(scale, scale);
            }

            // Custom background
            if (customBackground) {
                targetCtx.save();
                targetCtx.globalAlpha = bgOpacity / 100;
                if (bgBlur > 0) {
                    targetCtx.filter = `blur(${bgBlur}px)`;
                }
                targetCtx.drawImage(customBackground, 0, 0, 2100, 1200);
                targetCtx.filter = 'none';
                targetCtx.restore();
            }

            // Font upload handling
        function handleFontUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const fontFace = new FontFace('CustomFont', `url(${e.target.result})`);
                fontFace.load().then(function(loadedFont) {
                    document.fonts.add(loadedFont);
                    document.getElementById('fontFileName').textContent = `Loaded: ${file.name}`;
                    document.getElementById('mainFont').value = 'CustomFont';
                    redraw();
                }).catch(function(error) {
                    alert('Error loading font: ' + error);
                });
            };
            reader.readAsDataURL(file);
        }
        
        // Show/hide custom font upload
        document.addEventListener('DOMContentLoaded', function() {
            const mainFontSelect = document.getElementById('mainFont');
            if (mainFontSelect) {
                mainFontSelect.addEventListener('change', function() {
                    const uploadDiv = document.getElementById('customFontUpload');
                    if (this.value === 'custom') {
                        uploadDiv.style.display = 'block';
                    } else {
                        uploadDiv.style.display = 'none';
                    }
                });
            }
        });
            // Background shapes
            const bgShapeType = document.getElementById('bgShapeType').value;
            if (bgShapeType === 'circles') {
                drawGradientSplash(targetCtx, 600, 500, 450, primaryColor, 0.5);
                drawGradientSplash(targetCtx, 1000, 650, 400, '#00D1D6', 0.4);
                drawGradientSplash(targetCtx, 1400, 400, 350, accentColor, 0.3);
                drawGradientSplash(targetCtx, 800, 850, 380, primaryColor, 0.35);
            } else if (bgShapeType === 'hexagons') {
                drawHexagonPattern(targetCtx);
            } else if (bgShapeType === 'stars') {
                drawStarPattern(targetCtx);
            } else if (bgShapeType === 'diamonds') {
                drawDiamondPattern(targetCtx);
            }
            
            // Digital code
            if (document.getElementById('showDigitalCode').checked) {
                const codeText = document.getElementById('digitalCodeText').value || '01';
                drawDigitalCode(targetCtx, 500, 400, codeText, 0.15);
                drawDigitalCode(targetCtx, 1600, 850, codeText, 0.15);
            }
            
            // Symbols
            if (document.getElementById('showMusicNotes').checked) {
                const symbol = document.getElementById('musicNoteSymbol').value;
                drawSymbol(targetCtx, 620, 320, 48, 15, symbol);
                drawSymbol(targetCtx, 1420, 280, 56, -20, symbol);
                drawSymbol(targetCtx, 1650, 520, 40, 10, symbol);
                drawSymbol(targetCtx, 850, 920, 44, -15, symbol);
                drawSymbol(targetCtx, 1230, 970, 52, 25, symbol);
                drawSymbol(targetCtx, 400, 720, 36, 0, symbol);
            }
            
            // Glowing lines - controlled by checkbox
            const showLines = document.getElementById('showBackgroundLines');
            if (showLines && showLines.checked) {
                drawGlowingLine(targetCtx, 400, 300, 1700, 400, primaryColor, 2);
                drawGlowingLine(targetCtx, 450, 950, 1600, 850, accentColor, 2);
                drawGlowingLine(targetCtx, 300, 600, 550, 400, '#00D1D6', 2);
            }
            
            // Main cutout
            if (mikuCutout) {
                drawCutout(targetCtx, mikuCutout, 380, 600, 900, cutoutOpacity / 100, cutoutZoom / 100, cutoutOffsetX, cutoutOffsetY);
            }
            
            // Boxes
            boxes.forEach(box => {
                if (box.image) {
                    drawImageInBox(targetCtx, box);
                } else {
                    drawEmptyBox(targetCtx, box);
                }
            });
            
            // Banner
            const bannerX = parseInt(document.getElementById('bannerX').value);
            const bannerY = parseInt(document.getElementById('bannerY').value);
            const bannerWidth = parseInt(document.getElementById('bannerWidth').value);
            const bannerHeight = parseInt(document.getElementById('bannerHeight').value);
            const bannerRotation = parseInt(document.getElementById('bannerRotation').value);
            const bannerShape = document.getElementById('bannerShape').value;
            const mainText = document.getElementById('mainText').value || 'Miku';
            const subtitleText = document.getElementById('subtitleText').value || 'Hatsune';
            
            drawBanner(targetCtx, bannerX, bannerY, bannerWidth, bannerHeight, bannerRotation, mainText, subtitleText, bannerShape);
            
            if (scale !== 1) {
                targetCtx.restore();
            }
        }
        
        function drawGradientSplash(ctx, x, y, radius, color, opacity = 0.6) {
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
            gradient.addColorStop(0, color + Math.floor(opacity * 255).toString(16).padStart(2, '0'));
            gradient.addColorStop(0.5, color + '44');
            gradient.addColorStop(1, color + '00');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 2100, 1200);
        }

        function handleBackgroundUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    customBackground = img;
                    document.getElementById('preview-background').innerHTML = `<img src="${e.target.result}">`;
                    redraw();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function drawHexagonPattern(ctx) {
            ctx.strokeStyle = 'rgba(57, 197, 187, 0.2)';
            ctx.lineWidth = 2;
            for (let i = 0; i < 10; i++) {
                const x = Math.random() * 2100;
                const y = Math.random() * 1200;
                const size = Math.random() * 100 + 50;
                drawHexagon(ctx, x, y, size);
            }
        }
        
        function drawHexagon(ctx, x, y, size) {
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI / 3) * i;
                const px = x + size * Math.cos(angle);
                const py = y + size * Math.sin(angle);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.stroke();
        }
        
        function drawStarPattern(ctx) {
            ctx.fillStyle = 'rgba(255, 107, 157, 0.3)';
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * 2100;
                const y = Math.random() * 1200;
                const size = Math.random() * 15 + 5;
                drawStar(ctx, x, y, 5, size, size / 2);
            }
        }
        
        function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let step = Math.PI / spikes;
            
            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                let x = cx + Math.cos(rot) * outerRadius;
                let y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;
                
                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.fill();
        }
        
        function drawDiamondPattern(ctx) {
            ctx.strokeStyle = 'rgba(57, 197, 187, 0.2)';
            ctx.lineWidth = 2;
            for (let i = 0; i < 15; i++) {
                const x = Math.random() * 2100;
                const y = Math.random() * 1200;
                const size = Math.random() * 60 + 30;
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(45 * Math.PI / 180);
                ctx.strokeRect(-size/2, -size/2, size, size);
                ctx.restore();
            }
        }
        
        function drawDigitalCode(ctx, x, y, text, opacity) {
            ctx.save();
            ctx.fillStyle = `rgba(57, 197, 187, ${opacity})`;
            ctx.font = 'bold 200px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText(text, x, y);
            ctx.restore();
        }
        
        function drawSymbol(ctx, x, y, size, rotation, symbol) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(rotation * Math.PI / 180);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.font = `${size}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(symbol, 0, 0);
            ctx.restore();
        }
        
        function drawGlowingLine(ctx, x1, y1, x2, y2, color, width = 3) {
            ctx.save();
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.shadowColor = color;
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            ctx.restore();
        }
        
        function drawCutout(ctx, img, x, y, maxHeight, opacity, zoom, offsetX, offsetY) {
            ctx.save();
            ctx.globalAlpha = opacity;
            
            const scale = (maxHeight / img.height) * zoom;
            const scaledWidth = img.width * scale;
            const scaledHeight = img.height * scale;
            
            ctx.shadowColor = primaryColor;
            ctx.shadowBlur = 30;
            ctx.drawImage(img, x - scaledWidth / 2 + offsetX, y - scaledHeight / 2 + offsetY, scaledWidth, scaledHeight);
            ctx.restore();
        }
        
        function drawImageInBox(ctx, box) {
            ctx.save();
            ctx.globalAlpha = box.opacity / 100;
            ctx.translate(box.x, box.y);
            ctx.rotate(box.rotation * Math.PI / 180);
            
            // Clipping
            ctx.beginPath();
            ctx.moveTo(0, -box.size);
            ctx.lineTo(box.size, 0);
            ctx.lineTo(0, box.size);
            ctx.lineTo(-box.size, 0);
            ctx.closePath();
            ctx.clip();
            
            const zoom = box.zoom / 100;
            const scale = Math.max(box.size * 2 / box.image.width, box.size * 2 / box.image.height) * zoom;
            const scaledWidth = box.image.width * scale;
            const scaledHeight = box.image.height * scale;
            
            ctx.drawImage(box.image, -scaledWidth / 2 + box.offsetX, -scaledHeight / 2 + box.offsetY, scaledWidth, scaledHeight);
            ctx.restore();
            
            // Border
            ctx.save();
            ctx.translate(box.x, box.y);
            ctx.rotate(box.rotation * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(0, -box.size);
            ctx.lineTo(box.size, 0);
            ctx.lineTo(0, box.size);
            ctx.lineTo(-box.size, 0);
            ctx.closePath();
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 4;
            ctx.stroke();
            ctx.restore();
        }
        
        function drawEmptyBox(ctx, box) {
            ctx.save();
            ctx.translate(box.x, box.y);
            ctx.rotate(box.rotation * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(0, -box.size);
            ctx.lineTo(box.size, 0);
            ctx.lineTo(0, box.size);
            ctx.lineTo(-box.size, 0);
            ctx.closePath();
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 4;
            ctx.stroke();
            
            // Show marker if enabled
            if (document.getElementById('showBoxMarkers').checked) {
                ctx.fillStyle = primaryColor;
                ctx.font = 'bold 60px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.globalAlpha = 0.3;
                ctx.fillText(box.id.toString(), 0, 0);
            }
            
            ctx.restore();
        }
        
        function drawBanner(ctx, x, y, width, height, rotation, text, subtext, shape) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(rotation * Math.PI / 180);
            
            const useGradient = document.getElementById('useBannerGradient').checked;
            
            if (useGradient) {
                const gradient = ctx.createLinearGradient(-width/2, 0, width/2, 0);
                gradient.addColorStop(0, bannerColor);
                gradient.addColorStop(0.5, bannerColor2);
                gradient.addColorStop(1, bannerColor);
                ctx.fillStyle = gradient;
            } else {
                ctx.fillStyle = bannerColor;
            }
            
            if (shape === 'rounded') {
                const radius = 20;
                ctx.beginPath();
                ctx.moveTo(-width/2 + radius + 20, -height/2);
                ctx.lineTo(width/2 - radius, -height/2);
                ctx.arcTo(width/2, -height/2, width/2, -height/2 + radius, radius);
                ctx.lineTo(width/2 - 20, height/2 - radius);
                ctx.arcTo(width/2 - 20, height/2, width/2 - 20 - radius, height/2, radius);
                ctx.lineTo(-width/2 + radius, height/2);
                ctx.arcTo(-width/2, height/2, -width/2, height/2 - radius, radius);
                ctx.lineTo(-width/2 + 20, -height/2 + radius);
                ctx.arcTo(-width/2 + 20, -height/2, -width/2 + 20 + radius, -height/2, radius);
                ctx.closePath();
            } else if (shape === 'rectangle') {
                ctx.fillRect(-width/2, -height/2, width, height);
            } else if (shape === 'hexagon') {
                const w = width / 2;
                const h = height / 2;
                ctx.beginPath();
                ctx.moveTo(-w * 0.7, -h);
                ctx.lineTo(w * 0.7, -h);
                ctx.lineTo(w, 0);
                ctx.lineTo(w * 0.7, h);
                ctx.lineTo(-w * 0.7, h);
                ctx.lineTo(-w, 0);
                ctx.closePath();
            } else if (shape === 'ellipse') {
                ctx.beginPath();
                ctx.ellipse(0, 0, width/2, height/2, 0, 0, Math.PI * 2);
            } else if (shape === 'diamond') {
                ctx.beginPath();
                ctx.moveTo(0, -height/2);
                ctx.lineTo(width/2, 0);
                ctx.lineTo(0, height/2);
                ctx.lineTo(-width/2, 0);
                ctx.closePath();
            }
            
            ctx.fill();
            
            // Glow
            ctx.shadowColor = bannerColor;
            ctx.shadowBlur = 25;
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Border
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.6;
            ctx.stroke();
            ctx.globalAlpha = 1.0;
            
            // Text
            const mainFont = document.getElementById('mainFont').value;
            const mainSize = document.getElementById('mainTextSize').value;
            
            ctx.shadowColor = '#000000';
            ctx.shadowBlur = 15;
            ctx.shadowOffsetX = 5;
            ctx.shadowOffsetY = 5;
            
            ctx.font = `bold ${mainSize}px "${mainFont}", Impact`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            ctx.save();
            ctx.transform(1, 0, -0.15, 1, 0, 0);
            
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 12;
            ctx.strokeText(text, 0, -height/4);
            
            ctx.strokeStyle = primaryColor;
            ctx.lineWidth = 7;
            ctx.strokeText(text, 0, -height/4);
            
            ctx.strokeStyle = '#003333';
            ctx.lineWidth = 3;
            ctx.strokeText(text, 0, -height/4);
            
            ctx.fillStyle = 'white';
            ctx.fillText(text, 0, -height/4);
            
            ctx.shadowBlur = 0;
            ctx.globalAlpha = 0.5;
            const highlightGradient = ctx.createLinearGradient(0, -mainSize, 0, 0);
            highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
            highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            ctx.fillStyle = highlightGradient;
            ctx.fillText(text, 0, -height/4);
            ctx.globalAlpha = 1.0;
            
            ctx.restore();
            
            const subtitleFont = document.getElementById('subtitleFont').value;
            const subtitleSize = document.getElementById('subtitleTextSize').value;
            ctx.shadowBlur = 10;
            ctx.font = `bold ${subtitleSize}px "${subtitleFont}"`;
            
            ctx.strokeStyle = primaryColor;
            ctx.lineWidth = 6;
            ctx.strokeText(subtext, 0, height/4);
            
            ctx.strokeStyle = '#003333';
            ctx.lineWidth = 2;
            ctx.strokeText(subtext, 0, height/4);
            
            ctx.fillStyle = 'white';
            ctx.fillText(subtext, 0, height/4);
            
            // Sparkles
            if (document.getElementById('showSparkles').checked) {
                ctx.shadowBlur = 0;
                const sparkles = [
                    {x: -width/2 + 80, y: -height/4},
                    {x: width/2 - 80, y: -height/4},
                    {x: -width/3, y: height/3},
                    {x: width/3, y: height/3}
                ];
                
                sparkles.forEach(sparkle => {
                    drawSparkle(ctx, sparkle.x, sparkle.y, 6);
                });
            }
            
            ctx.restore();
        }
        
        function drawSparkle(ctx, x, y, size) {
            ctx.save();
            ctx.translate(x, y);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            
            for (let i = 0; i < 4; i++) {
                const angle = (Math.PI / 2) * i;
                const x1 = Math.cos(angle) * size;
                const y1 = Math.sin(angle) * size;
                
                if (i === 0) {
                    ctx.moveTo(x1, y1);
                } else {
                    const prevAngle = (Math.PI / 2) * (i - 1) + Math.PI / 4;
                    const prevX = Math.cos(prevAngle) * (size * 0.3);
                    const prevY = Math.sin(prevAngle) * (size * 0.3);
                    ctx.lineTo(prevX, prevY);
                    ctx.lineTo(x1, y1);
                }
            }
            
            ctx.closePath();
            ctx.fill();
            ctx.shadowColor = 'white';
            ctx.shadowBlur = 8;
            ctx.fill();
            ctx.restore();
        }
        
        function redraw() {
            drawToContext(ctx, canvas, canvas.width / 1920);
        }
        
        function openPreview() {
            drawToContext(previewCtx, previewCanvas, 1);
            document.getElementById('previewModal').classList.add('active');
        }
        
        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }
        
        function downloadImage() {
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = 1920;
            exportCanvas.height = 1080;
            const exportCtx = exportCanvas.getContext('2d');
            
            const tempBgWasChecked = document.getElementById('showTempBg').checked;
            if (tempBgWasChecked) {
                document.getElementById('showTempBg').checked = false;
            }
            
            drawToContext(previewCtx, previewCanvas, 1);
            exportCtx.drawImage(previewCanvas, 90, 60, 1920, 1080, 0, 0, 1920, 1080);
            
            if (tempBgWasChecked) {
                document.getElementById('showTempBg').checked = true;
                redraw();
            }
            
            const link = document.createElement('a');
            const mainText = document.getElementById('mainText').value.toLowerCase().replace(/\s+/g, '-');
            link.download = `${mainText}-profile-1920x1080.png`;
            link.href = exportCanvas.toDataURL('image/png');
            link.click();
        }
        
        // Save/Load - COMPLETE VERSION
        function saveConfiguration() {
            const config = {
                settings: {
                    mainText: document.getElementById('mainText').value,
                    subtitleText: document.getElementById('subtitleText').value,
                    mainFont: document.getElementById('mainFont').value,
                    subtitleFont: document.getElementById('subtitleFont').value,
                    mainTextSize: document.getElementById('mainTextSize').value,
                    subtitleTextSize: document.getElementById('subtitleTextSize').value,
                    bannerShape: document.getElementById('bannerShape').value,
                    bannerX: document.getElementById('bannerX').value,
                    bannerY: document.getElementById('bannerY').value,
                    bannerWidth: document.getElementById('bannerWidth').value,
                    bannerHeight: document.getElementById('bannerHeight').value,
                    bannerRotation: document.getElementById('bannerRotation').value,
                    showSparkles: document.getElementById('showSparkles').checked,
                    primaryColor: primaryColor,
                    accentColor: accentColor,
                    bannerColor: bannerColor,
                    bgShapeType: document.getElementById('bgShapeType').value,
                    showDigitalCode: document.getElementById('showDigitalCode').checked,
                    digitalCodeText: document.getElementById('digitalCodeText').value,
                    showMusicNotes: document.getElementById('showMusicNotes').checked,
                    musicNoteSymbol: document.getElementById('musicNoteSymbol').value,
                    showBoxMarkers: document.getElementById('showBoxMarkers').checked
                },
                boxes: boxes.map(b => ({
                    id: b.id,
                    type: b.type,
                    x: b.x,
                    y: b.y,
                    size: b.size,
                    rotation: b.rotation,
                    opacity: b.opacity,
                    zoom: b.zoom,
                    offsetX: b.offsetX,
                    offsetY: b.offsetY
                })),
                cutout: {
                    opacity: cutoutOpacity,
                    zoom: cutoutZoom,
                    offsetX: cutoutOffsetX,
                    offsetY: cutoutOffsetY
                }
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
            const link = document.createElement('a');
            link.download = 'miku-config.json';
            link.href = URL.createObjectURL(blob);
            link.click();
        }
        
        function loadConfiguration(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Apply settings
                    if (config.settings) {
                        document.getElementById('mainText').value = config.settings.mainText || 'Miku';
                        document.getElementById('subtitleText').value = config.settings.subtitleText || 'Hatsune';
                        document.getElementById('mainFont').value = config.settings.mainFont || 'Comic Sans MS';
                        document.getElementById('subtitleFont').value = config.settings.subtitleFont || 'Trebuchet MS';
                        document.getElementById('mainTextSize').value = config.settings.mainTextSize || 85;
                        document.getElementById('mainTextSizeValue').value = config.settings.mainTextSize || 85;
                        document.getElementById('subtitleTextSize').value = config.settings.subtitleTextSize || 38;
                        document.getElementById('subtitleTextSizeValue').value = config.settings.subtitleTextSize || 38;
                        document.getElementById('bannerShape').value = config.settings.bannerShape || 'rounded';
                        document.getElementById('bannerX').value = config.settings.bannerX || 1050;
                        document.getElementById('bannerXValue').value = config.settings.bannerX || 1050;
                        document.getElementById('bannerY').value = config.settings.bannerY || 800;
                        document.getElementById('bannerYValue').value = config.settings.bannerY || 800;
                        document.getElementById('bannerWidth').value = config.settings.bannerWidth || 780;
                        document.getElementById('bannerWidthValue').value = config.settings.bannerWidth || 780;
                        document.getElementById('bannerHeight').value = config.settings.bannerHeight || 140;
                        document.getElementById('bannerHeightValue').value = config.settings.bannerHeight || 140;
                        document.getElementById('bannerRotation').value = config.settings.bannerRotation || -3;
                        document.getElementById('bannerRotationValue').value = config.settings.bannerRotation || -3;
                        document.getElementById('showSparkles').checked = config.settings.showSparkles !== false;
                        document.getElementById('bgShapeType').value = config.settings.bgShapeType || 'circles';
                        document.getElementById('showDigitalCode').checked = config.settings.showDigitalCode !== false;
                        document.getElementById('digitalCodeText').value = config.settings.digitalCodeText || '01';
                        document.getElementById('showMusicNotes').checked = config.settings.showMusicNotes !== false;
                        document.getElementById('musicNoteSymbol').value = config.settings.musicNoteSymbol || '‚ô™';
                        document.getElementById('showBoxMarkers').checked = config.settings.showBoxMarkers !== false;
                        
                        // Colors
                        if (config.settings.primaryColor) syncColor('primaryColor', config.settings.primaryColor);
                        if (config.settings.accentColor) syncColor('accentColor', config.settings.accentColor);
                        if (config.settings.bannerColor) syncColor('bannerColor', config.settings.bannerColor);
                    }
                    
                    // Apply boxes
                    if (config.boxes) {
                        boxes = config.boxes.map(b => ({
                            ...b,
                            image: null
                        }));
                        nextBoxId = Math.max(...boxes.map(b => b.id)) + 1;
                        generateBoxControls();
                    }
                    
                    // Apply cutout settings
                    if (config.cutout) {
                        cutoutOpacity = config.cutout.opacity || 100;
                        cutoutZoom = config.cutout.zoom || 100;
                        cutoutOffsetX = config.cutout.offsetX || 0;
                        cutoutOffsetY = config.cutout.offsetY || 0;
                        
                        document.getElementById('opacity-cutout').value = cutoutOpacity;
                        document.getElementById('opacity-cutoutValue').value = cutoutOpacity;
                        document.getElementById('zoom-cutout').value = cutoutZoom;
                        document.getElementById('zoom-cutoutValue').value = cutoutZoom;
                        document.getElementById('offsetX-cutout').value = cutoutOffsetX;
                        document.getElementById('offsetX-cutoutValue').value = cutoutOffsetX;
                        document.getElementById('offsetY-cutout').value = cutoutOffsetY;
                        document.getElementById('offsetY-cutoutValue').value = cutoutOffsetY;
                    }
                    
                    alert('Configuration loaded successfully! (Note: Images are not included and need to be re-uploaded)');
                    redraw();
                } catch (err) {
                    alert('Error loading configuration file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Presets
        function applyPreset(preset) {
            if (preset === 'miku') {
                // Classic Miku layout
                primaryColor = '#39C5BB';
                accentColor = '#FF6B9D';
                bannerColor = '#39C5BB';
                syncColor('primaryColor', primaryColor);
                syncColor('accentColor', accentColor);
                syncColor('bannerColor', bannerColor);
                
                boxes = [
                    { id: 1, type: 'large', x: 920, y: 450, size: 330, rotation: 45, image: boxes[0]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 2, type: 'large', x: 1250, y: 600, size: 300, rotation: 15, image: boxes[1]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 3, type: 'large', x: 1530, y: 400, size: 280, rotation: -20, image: boxes[2]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 }
                ];
                
            } else if (preset === 'minimal') {
                // Minimal layout - single centered box
                boxes = [
                    { id: 1, type: 'large', x: 1200, y: 500, size: 400, rotation: 0, image: boxes[0]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 }
                ];
                
            } else if (preset === 'grid') {
                // Grid layout - 2x2
                boxes = [
                    { id: 1, type: 'large', x: 800, y: 400, size: 250, rotation: 0, image: boxes[0]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 2, type: 'large', x: 1200, y: 400, size: 250, rotation: 0, image: boxes[1]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 3, type: 'large', x: 800, y: 750, size: 250, rotation: 0, image: boxes[2]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 4, type: 'large', x: 1200, y: 750, size: 250, rotation: 0, image: boxes[3]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 }
                ];
                
            } else if (preset === 'diagonal') {
                // Diagonal layout
                boxes = [
                    { id: 1, type: 'large', x: 700, y: 350, size: 280, rotation: 45, image: boxes[0]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 2, type: 'large', x: 1100, y: 550, size: 280, rotation: 45, image: boxes[1]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 3, type: 'large', x: 1500, y: 750, size: 280, rotation: 45, image: boxes[2]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 }
                ];
                
            } else if (preset === 'centered') {
                // Centered circular layout
                boxes = [
                    { id: 1, type: 'large', x: 1050, y: 300, size: 220, rotation: 0, image: boxes[0]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 2, type: 'large', x: 750, y: 600, size: 220, rotation: 0, image: boxes[1]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 3, type: 'large', x: 1350, y: 600, size: 220, rotation: 0, image: boxes[2]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 },
                    { id: 4, type: 'large', x: 1050, y: 850, size: 220, rotation: 0, image: boxes[3]?.image || null, opacity: 100, zoom: 100, offsetX: 0, offsetY: 0 }
                ];
            }
            
            nextBoxId = Math.max(...boxes.map(b => b.id)) + 1;
            generateBoxControls();
            redraw();
        }
        
        function resetToDefaults() {
            if (!confirm('Reset all settings? Images will be kept.')) return;
            location.reload();
        }
        
        function clearAllImages() {
            if (!confirm('Clear all uploaded images?')) return;
            mikuCutout = null;
            boxes.forEach(b => b.image = null);
            document.getElementById('preview-cutout').innerHTML = '<span class="box-marker">C</span>';
            generateBoxControls();
            redraw();
        }
    </script>
</body>
</html>




























